"use strict";(self.webpackChunkbrightplanet_ventures=self.webpackChunkbrightplanet_ventures||[]).push([[660],{98:(e,t,r)=>{r.d(t,{A:()=>n});const n=(0,r(3797).A)("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]])},254:(e,t,r)=>{r.d(t,{Ay:()=>u});var n=r(9379),a=r(3792),o=r(5229);const i={PENDING:"pending",APPROVED:"approved",REJECTED:"rejected"},s={[i.PENDING]:{emoji:"\ud83d\udfe1",label:"Pending",color:"yellow",description:"Waiting for admin approval"},[i.APPROVED]:{emoji:"\ud83d\udfe2",label:"Approved",color:"green",description:"PINs allocated successfully"},[i.REJECTED]:{emoji:"\ud83d\udd34",label:"Rejected",color:"red",description:"Request declined by admin"}},c=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50;try{const{data:i,error:c}=await a.ND.from("pin_requests").select("id").limit(1);if(c&&("42P01"===c.code||"42703"===c.code||"PGRST106"===c.code||"PGRST301"===c.code))return console.warn("PIN requests table not found or RLS policies blocking access. Please run the database setup script."),[];const{data:d,error:l}=await a.ND.rpc("get_pin_requests",{p_promoter_id:e,p_status:t,p_limit:r});if(l){var o;if("42883"===l.code||"PGRST202"===l.code){console.warn("get_pin_requests function not found. Using direct table query."),console.warn("Using simple query without joins to avoid relationship issues.");let o=a.ND.from("pin_requests").select("*").order("created_at",{ascending:!1}).limit(r);e&&(o=o.eq("promoter_id",e)),t&&(o=o.eq("status",t));const{data:i,error:c}=await o;if(c){if("42P01"===c.code||"PGRST200"===c.code||"PGRST301"===c.code)return console.warn("pin_requests table not found, relationships missing, or RLS blocking access. Returning empty array."),[];throw c}return i.map(e=>(0,n.A)((0,n.A)({},e),{},{requested_pins:e.quantity,request_number:e.request_id,approved_by:e.processed_by,approved_at:e.response_date,promoter_name:"Promoter",promoter_email:"promoter@example.com",admin_name:null,statusConfig:s[e.status]||{emoji:"\u2753",label:"Unknown",color:"gray",description:"Unknown status"},formattedRequestNumber:e.formatted_request_id||"REQ-".concat(String(e.request_id||e.request_number).padStart(3,"0")),formattedDate:new Date(e.created_at).toLocaleDateString(),formattedTime:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}))}if(null!==(o=l.message)&&void 0!==o&&o.includes("does not exist")||"42703"===l.code)return console.warn("PIN requests table/function not found. Returning empty array."),[];throw l}return d.map(e=>(0,n.A)((0,n.A)({},e),{},{statusConfig:s[e.status]||{emoji:"\u2753",label:"Unknown",color:"gray",description:"Unknown status"},formattedRequestNumber:e.formatted_request_id||"REQ-".concat(String(e.request_number).padStart(3,"0")),formattedDate:new Date(e.created_at).toLocaleDateString(),formattedTime:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}))}catch(i){throw console.error("\u274c Failed to get PIN requests:",i),i}},d=async(e,t,r)=>{const{data:n,error:i}=await a.ND.from("pin_requests").select("*").eq("id",e).eq("status","pending").single();if(i||!n)throw new Error("Request not found or already processed");const s=await o.Ay.adminAllocatePins(n.promoter_id,n.quantity||n.requested_pins,t);if(!s.success)throw new Error("Failed to allocate PINs: ".concat(s.error));const{error:c}=await a.ND.from("pin_requests").update({status:"approved",processed_by:t,admin_notes:r,response_date:(new Date).toISOString()}).eq("id",e);if(c)throw new Error("Failed to update request status: ".concat(c.message));return{success:!0,request_id:e,promoter_id:n.promoter_id,allocated_pins:n.requested_pins,new_balance:s.balance_after,message:"PIN request approved and PINs allocated successfully"}},l=async(e,t,r)=>{const{data:n,error:o}=await a.ND.from("pin_requests").select("*").eq("id",e).eq("status","pending").single();if(o||!n)throw new Error("Request not found or already processed");const{error:i}=await a.ND.from("pin_requests").update({status:"rejected",processed_by:t,admin_notes:r||"Request rejected by admin",response_date:(new Date).toISOString()}).eq("id",e);if(i)throw new Error("Failed to update request status: ".concat(i.message));return{success:!0,request_id:e,promoter_id:n.promoter_id,message:"PIN request rejected"}},u={submitPinRequest:async function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;try{const{data:o,error:i}=await a.ND.rpc("submit_pin_request",{p_promoter_id:e,p_requested_pins:t,p_reason:r});if(i){var n;if("42883"===i.code||"PGRST202"===i.code){if(console.warn("submit_pin_request function not found. Using direct table insert."),!t||t<=0||t>1e3)throw new Error("Requested PINs must be between 1 and 1000");const{data:n}=await a.ND.from("pin_requests").select("id").eq("promoter_id",e).eq("status","pending");if(n&&n.length>0)throw new Error("You already have a pending PIN request. Please wait for admin approval.");const{data:o,error:i}=await a.ND.from("pin_requests").insert({promoter_id:e,quantity:t,reason:r||"PIN request submitted",category:"standard",urgency:"normal"}).select("*").single();if(i)throw i;return{success:!0,request_id:o.id,request_number:o.request_id,message:"PIN request submitted successfully"}}if(null!==(n=i.message)&&void 0!==n&&n.includes("does not exist"))throw new Error("PIN request system is not set up. Please contact administrator to run the database setup.");throw console.error("\u274c PIN request submission failed:",i),i}if(!o.success)throw console.error("\u274c PIN request returned error:",o.error),new Error(o.error||"PIN request submission failed");return o}catch(o){throw console.error("\u274c PIN request service error:",o),o}},getPinRequests:c,approvePinRequest:async function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;try{const{data:n,error:o}=await a.ND.rpc("approve_pin_request",{p_request_id:e,p_admin_id:t,p_admin_notes:r});if(o){if("42883"===o.code||"PGRST202"===o.code)return console.warn("approve_pin_request function not found. Using manual approval process."),await d(e,t,r);throw console.error("\u274c PIN request approval failed:",o),o}if(!n.success)throw console.error("\u274c PIN request approval returned error:",n.error),new Error(n.error||"PIN request approval failed");return n}catch(n){throw console.error("\u274c PIN request approval service error:",n),n}},rejectPinRequest:async function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;try{const{data:n,error:o}=await a.ND.rpc("reject_pin_request",{p_request_id:e,p_admin_id:t,p_admin_notes:r});if(o){if("42883"===o.code||"PGRST202"===o.code)return console.warn("reject_pin_request function not found. Using manual rejection process."),await l(e,t,r);throw console.error("\u274c PIN request rejection failed:",o),o}if(!n.success)throw console.error("\u274c PIN request rejection returned error:",n.error),new Error(n.error||"PIN request rejection failed");return n}catch(n){throw console.error("\u274c PIN request rejection service error:",n),n}},getPinRequestStats:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;try{const t=await c(e);return{totalRequests:t.length,pendingRequests:t.filter(e=>e.status===i.PENDING).length,approvedRequests:t.filter(e=>e.status===i.APPROVED).length,rejectedRequests:t.filter(e=>e.status===i.REJECTED).length,totalPinsRequested:t.reduce((e,t)=>e+t.requested_pins,0),totalPinsApproved:t.filter(e=>e.status===i.APPROVED).reduce((e,t)=>e+t.requested_pins,0)}}catch(t){return console.error("\u274c Failed to get PIN request stats:",t),{totalRequests:0,pendingRequests:0,approvedRequests:0,rejectedRequests:0,totalPinsRequested:0,totalPinsApproved:0}}},hasPendingRequests:async e=>{try{return(await c(e,i.PENDING,1)).length>0}catch(t){return console.error("\u274c Failed to check pending requests:",t),!1}},subscribeToPinRequests:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r="";t&&(r="promoter_id=eq.".concat(t));return a.ND.channel("pin-requests-changes").on("postgres_changes",{event:"*",schema:"public",table:"pin_requests",filter:r},t=>{e(t)}).subscribe()},formatPinRequest:e=>(0,n.A)((0,n.A)({},e),{},{displayTitle:"".concat(e.formattedRequestNumber," - ").concat(e.requested_pins," PIN").concat(e.requested_pins>1?"s":""),displayStatus:"".concat(e.statusConfig.emoji," ").concat(e.statusConfig.label),displayDate:"".concat(e.formattedDate," at ").concat(e.formattedTime),displayReason:e.reason||"No reason provided"}),validatePinRequest:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const r=[];return(!e||e<=0)&&r.push("Requested PINs must be greater than 0"),e>1e3&&r.push("Cannot request more than 1000 PINs at once"),t&&t.length>500&&r.push("Reason must be less than 500 characters"),{isValid:0===r.length,errors:r}},PIN_REQUEST_STATUS:i,PIN_REQUEST_CONFIG:s}},430:(e,t,r)=>{r.d(t,{A:()=>n});const n=(0,r(3797).A)("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]])},1065:(e,t,r)=>{r.d(t,{A:()=>n});const n=(0,r(3797).A)("XCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]])},5229:(e,t,r)=>{r.d(t,{Ay:()=>l,D7:()=>c,Lh:()=>d,getUserPinBalance:()=>s,hO:()=>o});var n=r(9379),a=r(3792);const o={CUSTOMER_CREATION:"customer_creation",ADMIN_ALLOCATION:"admin_allocation",ADMIN_DEDUCTION:"admin_deduction"},i={[o.CUSTOMER_CREATION]:{emoji:"\u274c",label:"Customer Creation",color:"red",sign:"-"},[o.ADMIN_ALLOCATION]:{emoji:"\u2705",label:"Admin Allocation",color:"green",sign:"+"},[o.ADMIN_DEDUCTION]:{emoji:"\u274c",label:"Admin Deduction",color:"red",sign:"-"}},s=async e=>{try{const{data:t,error:r}=await a.ND.from("profiles").select("pins").eq("id",e).single();if(r)throw r;return t.pins||0}catch(t){throw t}},c=(e,t)=>{if(null===t||void 0===t)return"0";if(!i[e])return t.toString();const r=Math.abs(t);return e===o.ADMIN_ALLOCATION?"+".concat(r):"-".concat(r)},d=e=>i[e]||{emoji:"\u2753",label:"Unknown",color:"gray",sign:""},l={executePinTransaction:async e=>{let{userId:t,actionType:r,pinChangeValue:n,createdBy:o=null,relatedEntityId:i=null,relatedEntityName:s=null}=e;try{const{data:e,error:c}=await a.ND.rpc("execute_pin_transaction",{p_user_id:t,p_action_type:r,p_pin_change_value:n,p_created_by:o,p_related_entity_id:i,p_related_entity_name:s});if(c)throw c;if(!e.success)throw new Error(e.error||"PIN transaction failed");return e}catch(c){throw c}},deductPinForCustomerCreation:async(e,t,r)=>{try{const{data:n,error:o}=await a.ND.rpc("deduct_pin_for_customer_creation",{p_promoter_id:e,p_customer_id:t,p_customer_name:r});if(o)throw o;if(!n.success)throw new Error(n.error||"Customer creation PIN deduction failed");return n}catch(n){throw n}},adminAllocatePins:async(e,t,r)=>{try{const{data:n,error:o}=await a.ND.rpc("admin_allocate_pins",{p_target_user_id:e,p_pin_amount:Math.abs(t),p_admin_id:r});if(o)throw o;if(!n.success)throw new Error(n.error||"Admin PIN allocation failed");return n}catch(n){throw n}},adminDeductPins:async(e,t,r)=>{try{const{data:n,error:o}=await a.ND.rpc("admin_deduct_pins",{p_target_user_id:e,p_pin_amount:Math.abs(t),p_admin_id:r});if(o)throw o;if(!n.success)throw new Error(n.error||"Admin PIN deduction failed");return n}catch(n){throw n}},getUserPinTransactions:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50;try{let{data:r,error:o}=await a.ND.from("pin_transactions").select("\n        id,\n        transaction_id,\n        action_type,\n        pin_change_value,\n        balance_before,\n        balance_after,\n        note,\n        created_at,\n        created_by,\n        related_entity_id,\n        creator:profiles!created_by(name, email)\n      ").eq("user_id",e).order("created_at",{ascending:!1}).limit(t);if(o)throw o;if(0===r.length){const{data:n,error:o}=await a.ND.from("pin_transactions").select("\n          id,\n          transaction_id,\n          action_type,\n          pin_change_value,\n          balance_before,\n          balance_after,\n          note,\n          created_at,\n          created_by,\n          related_entity_id,\n          creator:profiles!created_by(name, email)\n        ").eq("promoter_id",e).order("created_at",{ascending:!1}).limit(t);if(o)throw o;r=n}return r.map(e=>{var t;return(0,n.A)((0,n.A)({},e),{},{displayConfig:i[e.action_type]||{emoji:"\u2753",label:"Unknown",color:"gray",sign:""},formattedAmount:c(e.action_type,e.pin_change_value),creatorName:(null===(t=e.creator)||void 0===t?void 0:t.name)||"System"})})}catch(r){throw r}},getAllPinTransactions:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;try{let s=a.ND.from("pin_transactions").select("\n        id,\n        transaction_id,\n        user_id,\n        action_type,\n        pin_change_value,\n        balance_before,\n        balance_after,\n        note,\n        created_at,\n        created_by,\n        related_entity_id,\n        user:profiles!user_id(id, name, email, role, promoter_id),\n        creator:profiles!created_by(id, name, email)\n      ").order("created_at",{ascending:!1}).limit(t);e.actionType&&"all"!==e.actionType&&(s=s.eq("action_type",e.actionType)),e.userId&&(s=s.eq("user_id",e.userId)),e.dateFrom&&(s=s.gte("created_at",e.dateFrom)),e.dateTo&&(s=s.lte("created_at",e.dateTo));const{data:d,error:l}=await s;if(l)throw l;d.filter(e=>!e.user||!e.user.name);let u=new Map,_=new Map,p=new Map;try{const{data:e,error:t}=await a.ND.from("profiles").select("id, name, email, role, promoter_id, parent_promoter_id, created_at").in("role",["promoter","admin","customer"]);!t&&e&&e.forEach(e=>{u.set(e.id,e),"customer"===e.role&&_.set(e.id,e)})}catch(r){}try{const{data:e,error:t}=await a.ND.from("pin_usage_log").select("transaction_id, promoter_id, customer_id, action_type, created_at").not("transaction_id","is",null);!t&&e&&e.forEach(e=>{e.transaction_id&&p.set(e.transaction_id,e)})}catch(r){}return d.map(e=>{var t,r,a,s,d,l;let m=e.action_type;if(!m){if(e.note){const t=e.note.toLowerCase();t.includes("customer creation")||t.includes("customer")?m="customer_creation":t.includes("admin allocation")||t.includes("allocation")?m="admin_allocation":t.includes("deduction")&&(m="admin_deduction")}m||(m=e.pin_change_value>0?"admin_allocation":"customer_creation")}let f=e.user;if(!f||!f.name){if(e.user_id&&u.has(e.user_id))f=u.get(e.user_id);else if(("customer_creation"===m||"customer_creation"===e.action_type)&&e.related_entity_id){const t=_.get(e.related_entity_id);if(t&&t.parent_promoter_id){const e=u.get(t.parent_promoter_id);e&&(f=e)}}if(!f||!f.name)if(e.transaction_id&&p.has(e.transaction_id)){const t=p.get(e.transaction_id);t.promoter_id&&u.has(t.promoter_id)&&(f=u.get(t.promoter_id))}else if(e.created_at&&("customer_creation"===m||"customer_creation"===e.action_type)){const t=new Date(e.created_at).getTime(),r=5e3;for(const[e,n]of p.entries())if(n.created_at&&n.promoter_id){const e=new Date(n.created_at).getTime();if(Math.abs(t-e)<=r&&u.has(n.promoter_id)){f=u.get(n.promoter_id);break}}}if((!f||!f.name)&&("customer_creation"===m||"customer_creation"===e.action_type)&&!e.related_entity_id&&e.created_at){const t=new Date(e.created_at).getTime(),r=5e3;for(const[e,n]of _.entries())if(n.created_at){const e=new Date(n.created_at).getTime();if(Math.abs(t-e)<=r&&n.parent_promoter_id){const e=u.get(n.parent_promoter_id);if(e){f=e;break}}}}}!f||f.name;let h=m||e.action_type;i[h]||(h="customer_creation"===h?o.CUSTOMER_CREATION:"admin_allocation"===h?o.ADMIN_ALLOCATION:"admin_deduction"===h?o.ADMIN_DEDUCTION:e.pin_change_value>0?o.ADMIN_ALLOCATION:o.CUSTOMER_CREATION,e.action_type);let g=null;return null!==(t=f)&&void 0!==t&&t.promoter_id?g=f.promoter_id:"admin"===(null===(r=f)||void 0===r?void 0:r.role)&&(g=null),(0,n.A)((0,n.A)({},e),{},{action_type:h,displayConfig:i[h]||{emoji:"\u2753",label:"Unknown",color:"gray",sign:""},formattedAmount:c(h,e.pin_change_value||0),userName:(null===(a=f)||void 0===a?void 0:a.name)||null,userEmail:(null===(s=f)||void 0===s?void 0:s.email)||null,userRole:(null===(d=f)||void 0===d?void 0:d.role)||null,userPromoterId:g,creatorName:(null===(l=e.creator)||void 0===l?void 0:l.name)||null})})}catch(s){throw s}},getUserPinBalance:s,getPinTransactionStats:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;try{let t=a.ND.from("pin_transactions").select("action_type, pin_change_value");e&&(t=t.eq("user_id",e));let{data:r,error:n}=await t;if(n)throw n;if(0===r.length&&e){const{data:t,error:n}=await a.ND.from("pin_transactions").select("action_type, pin_change_value").eq("promoter_id",e);if(n)throw n;r=t}return{totalTransactions:r.length,customerCreations:r.filter(e=>e.action_type===o.CUSTOMER_CREATION).length,adminAllocations:r.filter(e=>e.action_type===o.ADMIN_ALLOCATION).length,adminDeductions:r.filter(e=>e.action_type===o.ADMIN_DEDUCTION).length,totalPinsAllocated:r.filter(e=>e.action_type===o.ADMIN_ALLOCATION).reduce((e,t)=>e+Math.abs(t.pin_change_value),0),totalPinsDeducted:r.filter(e=>e.action_type!==o.ADMIN_ALLOCATION).reduce((e,t)=>e+Math.abs(t.pin_change_value),0)}}catch(t){throw t}},formatPinAmount:c,getActionTypeDisplay:d,validatePinTransaction:(e,t,r)=>{const n=[];return Object.values(o).includes(e)||n.push("Invalid action type"),(!t||t<=0)&&n.push("PIN amount must be greater than 0"),r||n.push("User ID is required"),{isValid:0===n.length,errors:n}},subscribeToPinBalance:(e,t)=>a.ND.channel("pin-balance-changes").on("postgres_changes",{event:"*",schema:"public",table:"pin_transactions",filter:"user_id=eq.".concat(e)},e=>{t(e)}).subscribe(),subscribeToPinTransactions:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r="";t&&(r="user_id=eq.".concat(t));return a.ND.channel("pin-transactions-changes").on("postgres_changes",{event:"*",schema:"public",table:"pin_transactions",filter:r},t=>{e(t)}).subscribe()},PIN_ACTION_TYPES:o,PIN_DISPLAY_CONFIG:i}},9213:(e,t,r)=>{r.d(t,{A:()=>n});const n=(0,r(3797).A)("Pin",[["line",{x1:"12",x2:"12",y1:"17",y2:"22",key:"1jrz49"}],["path",{d:"M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z",key:"13yl11"}]])}}]);
//# sourceMappingURL=660.c3b53e9c.chunk.js.map