"use strict";(self.webpackChunkbrightplanet_ventures=self.webpackChunkbrightplanet_ventures||[]).push([[779],{1754:(e,t,r)=>{r.d(t,{YB:()=>x,bT:()=>d,cU:()=>l,xk:()=>m});r(5043);var s=r(579);const i="rgba(247, 147, 30, 0.1)",o="rgba(255, 255, 255, 0.05)",a="\n  @keyframes bp-skeleton-shimmer {\n    0% {\n      background-position: -200px 0;\n    }\n    100% {\n      background-position: calc(200px + 100%) 0;\n    }\n  }\n  \n  .bp-skeleton-shimmer {\n    background: linear-gradient(\n      90deg,\n      ".concat(o," 25%,\n      ").concat(i," 50%,\n      ").concat(o," 75%\n    );\n    background-size: 200px 100%;\n    animation: bp-skeleton-shimmer 1.5s infinite linear;\n  }\n");if("undefined"!==typeof document&&!document.getElementById("bp-skeleton-styles")){const e=document.createElement("style");e.id="bp-skeleton-styles",e.textContent=a,document.head.appendChild(e)}const n=e=>{let{width:t="100%",height:r="1rem",className:i="",rounded:a="rounded-lg",animate:n=!0}=e;return(0,s.jsx)("div",{className:"".concat(a," border border-white/10 ").concat(n?"bp-skeleton-shimmer":""," ").concat(i),style:{width:t,height:r,background:n?void 0:o}})},c=e=>{let{className:t=""}=e;return(0,s.jsxs)("div",{className:"bg-white/5 backdrop-blur-sm border border-slate-200/10 rounded-xl p-4 h-full ".concat(t),children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,s.jsx)(n,{width:"3rem",height:"3rem",rounded:"rounded-xl"}),(0,s.jsx)(n,{width:"3rem",height:"2rem"})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(n,{width:"70%",height:"1rem"}),(0,s.jsx)(n,{width:"90%",height:"0.75rem"})]})]})},l=e=>{let{rows:t=5,columns:r=4,className:i=""}=e;return(0,s.jsxs)("div",{className:"bg-white/5 backdrop-blur-sm border border-slate-200/10 rounded-xl overflow-hidden ".concat(i),children:[(0,s.jsx)("div",{className:"bg-white/5 p-4 border-b border-white/10",children:(0,s.jsx)("div",{className:"grid gap-4",style:{gridTemplateColumns:"repeat(".concat(r,", 1fr)")},children:Array.from({length:r}).map((e,t)=>(0,s.jsx)(n,{width:"80%",height:"1rem"},t))})}),(0,s.jsx)("div",{className:"divide-y divide-white/10",children:Array.from({length:t}).map((e,t)=>(0,s.jsx)("div",{className:"p-4",children:(0,s.jsx)("div",{className:"grid gap-4",style:{gridTemplateColumns:"repeat(".concat(r,", 1fr)")},children:Array.from({length:r}).map((e,t)=>(0,s.jsx)(n,{width:0===t?"90%":"70%",height:"1rem"},t))})},t))})]})},d=e=>{let{count:t=2,className:r=""}=e;return(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 ".concat(r),children:Array.from({length:t}).map((e,t)=>(0,s.jsx)(c,{},t))})},m=e=>{let{count:t=4,className:r=""}=e;return(0,s.jsx)("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4 ".concat(r),children:Array.from({length:t}).map((e,t)=>(0,s.jsx)("div",{className:"bg-white/5 backdrop-blur-sm border border-slate-200/10 rounded-xl p-5 h-full",children:(0,s.jsxs)("div",{className:"text-center space-y-4",children:[(0,s.jsx)(n,{width:"3.5rem",height:"3.5rem",rounded:"rounded-xl",className:"mx-auto"}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(n,{width:"70%",height:"1rem",className:"mx-auto"}),(0,s.jsx)(n,{width:"90%",height:"0.75rem",className:"mx-auto"})]})]})},t))})},u=e=>{let{className:t=""}=e;return(0,s.jsxs)("div",{className:"text-center mb-6 ".concat(t),children:[(0,s.jsx)(n,{width:"4rem",height:"4rem",rounded:"rounded-2xl",className:"mx-auto mb-4"}),(0,s.jsx)(n,{width:"15rem",height:"2rem",className:"mx-auto mb-2"}),(0,s.jsx)(n,{width:"20rem",height:"1rem",className:"mx-auto"})]})},h=e=>{let{className:t=""}=e;return(0,s.jsxs)("div",{className:"flex flex-col md:flex-row gap-4 mb-6 ".concat(t),children:[(0,s.jsx)("div",{className:"flex-1",children:(0,s.jsx)(n,{width:"100%",height:"2.5rem",rounded:"rounded-lg"})}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(n,{width:"8rem",height:"2.5rem",rounded:"rounded-lg"}),(0,s.jsx)(n,{width:"6rem",height:"2.5rem",rounded:"rounded-lg"})]})]})},p=e=>{let{className:t=""}=e;return(0,s.jsxs)("div",{className:"bg-white/5 backdrop-blur-sm border border-slate-200/10 rounded-xl p-6 ".concat(t),children:[(0,s.jsxs)("div",{className:"flex justify-between items-start mb-4",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(n,{width:"8rem",height:"1rem"}),(0,s.jsx)(n,{width:"6rem",height:"0.75rem"})]}),(0,s.jsx)(n,{width:"4rem",height:"1.5rem",rounded:"rounded-full"})]}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)(n,{width:"4rem",height:"0.75rem"}),(0,s.jsx)(n,{width:"6rem",height:"0.75rem"})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)(n,{width:"5rem",height:"0.75rem"}),(0,s.jsx)(n,{width:"7rem",height:"0.75rem"})]})]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-2 mt-4 pt-4 border-t border-white/10",children:[(0,s.jsx)(n,{width:"4rem",height:"2rem",rounded:"rounded-lg"}),(0,s.jsx)(n,{width:"4rem",height:"2rem",rounded:"rounded-lg"})]})]})},x=e=>{let{type:t="dashboard"}=e;switch(t){case"dashboard":return(0,s.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900",children:(0,s.jsxs)("div",{className:"max-w-7xl mx-auto px-6 py-6",children:[(0,s.jsx)(u,{}),(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(n,{width:"10rem",height:"1.5rem",className:"mb-4"}),(0,s.jsx)(d,{})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)(n,{width:"12rem",height:"1.5rem",className:"mb-4"}),(0,s.jsx)(m,{})]})]})]})});case"table":return(0,s.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900",children:(0,s.jsxs)("div",{className:"max-w-7xl mx-auto px-6 py-6",children:[(0,s.jsx)(u,{}),(0,s.jsx)(h,{}),(0,s.jsx)(l,{rows:8,columns:5})]})});case"cards":return(0,s.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900",children:(0,s.jsxs)("div",{className:"max-w-7xl mx-auto px-6 py-6",children:[(0,s.jsx)(u,{}),(0,s.jsx)(h,{}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:Array.from({length:6}).map((e,t)=>(0,s.jsx)(p,{},t))})]})});default:return(0,s.jsx)(x,{type:"dashboard"})}}},2380:(e,t,r)=>{r.d(t,{A:()=>s});const s=(0,r(3797).A)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},2779:(e,t,r)=>{r.r(t),r.d(t,{default:()=>N});var s=r(5043),i=r(6621),o=r(1921),a=r(1460),n=r(1761),c=r(5852),l=r(3959),d=r(6127);const m={getAllPinTransactions:async()=>{try{const{data:e,error:t}=await d.ND.from("pin_transactions").select("*").order("created_at",{ascending:!1});if(t)throw t;return e||[]}catch(e){throw console.error("Error fetching pin transactions:",e),e}},getCustomerPinTransactions:async e=>{try{const{data:t,error:r}=await d.ND.from("pin_transactions").select("*").eq("customer_id",e).order("created_at",{ascending:!1});if(r)throw r;return t||[]}catch(t){throw console.error("Error fetching pin transactions for customer ".concat(e,":"),t),t}},createPinTransaction:async e=>{try{const{data:t,error:r}=await d.ND.from("pin_transactions").insert([e]).select();if(r)throw r;return null===t||void 0===t?void 0:t[0]}catch(t){throw console.error("Error creating pin transaction:",t),t}},updatePinTransaction:async(e,t)=>{try{const{data:r,error:s}=await d.ND.from("pin_transactions").update(t).eq("id",e).select();if(s)throw s;return null===r||void 0===r?void 0:r[0]}catch(r){throw console.error("Error updating pin transaction ".concat(e,":"),r),r}},deletePinTransaction:async e=>{try{const{error:t}=await d.ND.from("pin_transactions").delete().eq("id",e);if(t)throw t}catch(t){throw console.error("Error deleting pin transaction ".concat(e,":"),t),t}},deductPinForCustomerCreation:async(e,t,r)=>{try{if(console.log("\ud83d\udccc PIN Deduction - Input values:",{promoterId:e,customerId:t,customerName:r}),!e)return console.error("\u274c Promoter ID is missing for PIN deduction"),{success:!1,error:"Promoter ID is required"};if(!t)return console.error("\u274c Customer ID is missing for PIN deduction"),{success:!1,error:"Customer ID is required"};const{data:s,error:i}=await d.ND.rpc("deduct_promoter_pin",{promoter_id:e,pins_to_deduct:1});if(i)return console.error("\u274c Failed to deduct PIN:",i),{success:!1,error:i.message};console.log("\u2705 PIN deduction successful:",s);const o={promoter_id:e,customer_id:t,transaction_type:"deduction",pins_count:1,description:"PIN used for customer creation: ".concat(r||"New Customer")};console.log("\ud83d\udcdd Recording PIN transaction:",o);const{data:a,error:n}=await d.ND.from("pin_transactions").insert([o]).select();return n?(console.error("\u274c Failed to record PIN transaction:",n),{success:!1,error:n.message}):(console.log("\u2705 PIN transaction recorded successfully"),{success:!0,data:null===a||void 0===a?void 0:a[0]})}catch(s){return console.error("\u274c Error in deductPinForCustomerCreation:",s),{success:!1,error:s.message}}}};var u=r(3489),h=r(2380),p=r(9256),x=r(8112),f=r(9589),g=r(5680),y=r(5722),v=r(6787),w=r(6339),b=r(1754),_=r(579);const N=function(){const{user:e}=(0,i.As)(),{showSuccess:t,showError:r}=(0,o.L5)();(0,l.r9)();const[N,j]=(0,s.useState)([]),[A,C]=(0,s.useState)([]),[k,I]=(0,s.useState)([]),[D,S]=(0,s.useState)(""),[P,E]=(0,s.useState)(""),[T,q]=(0,s.useState)(!1),[M,O]=(0,s.useState)(!1),[L,F]=(0,s.useState)(null),[R,U]=(0,s.useState)(null),[B,z]=(0,s.useState)(!0),[H,V]=(0,s.useState)(!1),[J,$]=(0,s.useState)(null);(0,s.useEffect)(()=>{W(),X()},[]),(0,s.useEffect)(()=>{let e=N||[];D&&(e=e.filter(e=>{const t=((null===e||void 0===e?void 0:e.name)||"").toLowerCase(),r=((null===e||void 0===e?void 0:e.email)||"").toLowerCase(),s=((null===e||void 0===e?void 0:e.phone)||"").toLowerCase(),i=((null===e||void 0===e?void 0:e.customer_id)||"").toLowerCase(),o=(D||"").toLowerCase();return t.includes(o)||r.includes(o)||s.includes(o)||i.includes(o)})),P&&(e=e.filter(e=>((null===e||void 0===e?void 0:e.status)||"active").toLowerCase()===P.toLowerCase())),I(e)},[N,D,P]);const W=async()=>{try{z(!0);const{data:e,error:t}=await d.ND.from("profiles").select("\n          id,\n          name,\n          email,\n          phone,\n          customer_id,\n          state,\n          city,\n          pincode,\n          address,\n          saving_plan,\n          parent_promoter_id,\n          status,\n          created_at,\n          updated_at\n        ").eq("role","customer").order("created_at",{ascending:!1});if(t)throw j([]),I([]),t;j(e||[]),I(e||[])}catch(e){j([]),I([])}finally{z(!1)}},X=async()=>{try{const{data:e,error:t}=await d.ND.from("profiles").select("id, name, email, promoter_id, created_at").eq("role","promoter").order("created_at",{ascending:!1});if(t)throw t;C(e||[])}catch(e){C([])}},Y=()=>{q(!1),F(null)},Z=()=>{O(!1),U(null)};return(0,_.jsxs)(_.Fragment,{children:[(0,_.jsx)(l.wE,{}),(0,_.jsx)(a.A,{}),(0,_.jsxs)(l.dQ,{children:[(0,_.jsx)("div",{className:"min-h-screen pt-40 px-8 pb-8",children:(0,_.jsxs)("div",{className:"max-w-7xl mx-auto",children:[(0,_.jsxs)("div",{className:"flex justify-between items-center mb-8","data-animate":!0,children:[(0,_.jsxs)("div",{children:[(0,_.jsx)("h1",{className:"text-4xl font-bold text-white mb-2",children:"Customer Management"}),(0,_.jsx)("p",{className:"text-gray-300",children:"Manage customer accounts and assignments"})]}),(0,_.jsxs)(l.Rq,{onClick:()=>{F(null),q(!0)},className:"flex items-center space-x-2",children:[(0,_.jsx)(h.A,{className:"w-5 h-5"}),(0,_.jsx)("span",{children:"Create Customer"})]})]}),(0,_.jsx)(l.Xg,{className:"p-6 mb-8","data-animate":!0,children:(0,_.jsxs)("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:[(0,_.jsxs)("div",{className:"flex-1 relative",children:[(0,_.jsx)(p.A,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),(0,_.jsx)("input",{type:"text",placeholder:"Search by name, email, phone, or customer ID...",value:D,onChange:e=>S(e.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500"})]}),(0,_.jsx)("div",{className:"flex gap-4",children:(0,_.jsxs)("select",{value:P,onChange:e=>E(e.target.value),className:"px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500",children:[(0,_.jsx)("option",{value:"",children:"All Status"}),(0,_.jsx)("option",{value:"active",children:"Active"}),(0,_.jsx)("option",{value:"inactive",children:"Inactive"})]})})]})}),(0,_.jsx)(l.Xg,{className:"overflow-hidden","data-animate":!0,children:B?(0,_.jsx)(b.cU,{rows:8,columns:6}):(0,_.jsx)("div",{className:"overflow-x-auto",children:(0,_.jsxs)("table",{className:"w-full",children:[(0,_.jsx)("thead",{className:"bg-gray-700",children:(0,_.jsxs)("tr",{children:[(0,_.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider",children:"Customer Details"}),(0,_.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider",children:"Contact Details"}),(0,_.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider",children:"Saving Plan"}),(0,_.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider",children:"Assigned Promoter"}),(0,_.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider",children:"Status"}),(0,_.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider",children:"Actions"})]})}),(0,_.jsx)("tbody",{className:"bg-gray-800 divide-y divide-gray-700",children:0===k.length?(0,_.jsx)("tr",{children:(0,_.jsx)("td",{colSpan:"6",className:"px-6 py-12 text-center text-gray-400",children:"No customers found"})}):k.map(e=>{const s=null===e||void 0===e?void 0:e.id,i=(null===e||void 0===e?void 0:e.name)||"Unknown",o=(null===e||void 0===e?void 0:e.email)||"N/A",a=(null===e||void 0===e?void 0:e.phone)||"N/A",n=(null===e||void 0===e?void 0:e.customer_id)||"N/A",c=(null===e||void 0===e?void 0:e.status)||"active",l=(e=>{const t=null===e||void 0===e?void 0:e.parent_promoter_id;if(!t)return"Unassigned";const r=(A||[]).find(e=>(null===e||void 0===e?void 0:e.id)===t);return(null===r||void 0===r?void 0:r.name)||"Unknown Promoter"})(e),m=(e=>{const t=null===e||void 0===e?void 0:e.parent_promoter_id;if(!t)return"";const r=(A||[]).find(e=>(null===e||void 0===e?void 0:e.id)===t);return(null===r||void 0===r?void 0:r.promoter_id)||""})(e);return(0,_.jsxs)("tr",{className:"hover:bg-gray-700",children:[(0,_.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,_.jsxs)("div",{className:"flex items-center",children:[(0,_.jsx)("div",{className:"w-8 h-8 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mr-3",children:(0,_.jsx)(x.A,{className:"w-4 h-4 text-white"})}),(0,_.jsxs)("div",{className:"flex flex-col",children:[(0,_.jsx)("span",{className:"text-white font-medium",children:i}),(0,_.jsx)("span",{className:"text-xs text-gray-400",children:n})]})]})}),(0,_.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-300",children:(0,_.jsxs)("div",{className:"space-y-1",children:[(0,_.jsxs)("div",{className:"flex items-center",children:[(0,_.jsx)(f.A,{className:"w-3 h-3 mr-2 text-gray-400"}),"N/A"===o?"No email":o]}),(0,_.jsxs)("div",{className:"flex items-center",children:[(0,_.jsx)(g.A,{className:"w-3 h-3 mr-2 text-gray-400"}),"N/A"===a?"No phone":a]})]})}),(0,_.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-300",children:(0,_.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-500/20 text-blue-400",children:"\u20b91000 \xd7 20 months"})}),(0,_.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-300",children:(0,_.jsxs)("div",{className:"flex items-center",children:[(0,_.jsx)(x.A,{className:"w-4 h-4 mr-2 text-blue-400"}),(0,_.jsxs)("div",{className:"flex flex-col",children:[(0,_.jsx)("span",{className:"text-white font-medium",children:l}),m&&(0,_.jsx)("span",{className:"text-xs text-gray-400",children:m})]})]})}),(0,_.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,_.jsx)("button",{onClick:()=>(async e=>{try{const r="active"===(e.status||"active")?"inactive":"active",{error:s}=await d.ND.from("profiles").update({status:r}).eq("id",e.id);if(s)throw s;t("Customer status updated successfully.\n\n".concat(e.name," is now ").concat(r,".")),await W()}catch(s){r("Failed to update customer status. Please try again.")}})(e),className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium transition-colors ".concat("active"===c?"bg-green-100 text-green-800 hover:bg-green-200":"bg-red-100 text-red-800 hover:bg-red-200"),title:"Click to ".concat("active"===c?"deactivate":"activate"," customer"),children:"active"===c?"\u2705 Active":"\u274c Inactive"})}),(0,_.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:(0,_.jsxs)("div",{className:"flex space-x-2",children:[(0,_.jsx)("button",{onClick:()=>(e=>{$(e),V(!0)})(e),className:"text-green-400 hover:text-green-300 transition-colors",title:"Manage Payments",children:(0,_.jsx)(y.A,{className:"w-4 h-4"})}),(0,_.jsx)("button",{onClick:()=>(e=>{F(e),q(!0)})(e),className:"text-orange-400 hover:text-orange-300 transition-colors",title:"Edit Customer",children:(0,_.jsx)(v.A,{className:"w-4 h-4"})}),(0,_.jsx)("button",{onClick:()=>(e=>{U(e),O(!0)})(e),className:"text-red-400 hover:text-red-300 transition-colors",title:"Delete Customer",children:(0,_.jsx)(w.A,{className:"w-4 h-4"})})]})})]},s)})})]})})})]})}),(0,_.jsx)(n.A,{isOpen:T,onClose:Y,onSubmit:async e=>{try{if(L){const{error:r}=await d.ND.from("profiles").update({savingPlan:e.savingPlan||"\u20b91000 per month for 20 months",phone:e.mobile,email:e.email||null,state:e.state,city:e.city,pincode:e.pincode,address:e.address,updated_at:(new Date).toISOString()}).eq("id",L.id);if(r)throw r;t("Customer updated successfully.\n\n".concat(e.name,"'s information has been saved.")),await W(),Y()}else{var s,i,o,a,n,c,l,h,p;if(null===(s=e.name)||void 0===s||!s.trim()||null===(i=e.mobile)||void 0===i||!i.trim()||null===(o=e.cardNo)||void 0===o||!o.trim())throw new Error("Missing required fields: name, mobile, and customer ID are mandatory");if(!/^[6-9]\d{9}$/.test(e.mobile.trim()))throw new Error("Invalid mobile number format");if(!/^[A-Z0-9]{3,20}$/i.test(e.cardNo.trim()))throw new Error("Card No must be 3-20 alphanumeric characters");if(!e.password||e.password.length<6)throw new Error("Password must be at least 6 characters long");if(!/^\d{6}$/.test((null===(a=e.pincode)||void 0===a?void 0:a.trim())||""))throw new Error("Pincode must be exactly 6 digits");const r={p_name:e.name.trim(),p_mobile:e.mobile.trim(),p_state:(null===(n=e.state)||void 0===n?void 0:n.trim())||"",p_city:(null===(c=e.city)||void 0===c?void 0:c.trim())||"",p_pincode:(null===(l=e.pincode)||void 0===l?void 0:l.trim())||"",p_address:(null===(h=e.address)||void 0===h?void 0:h.trim())||"",p_customer_id:e.cardNo.trim().toUpperCase(),p_password:e.password,p_parent_promoter_id:e.parentPromoter,p_email:(null===(p=e.email)||void 0===p?void 0:p.trim())||null},{data:x,error:f}=await d.ND.from("profiles").select("pins, name").eq("id",e.parentPromoter).eq("role","promoter").single();if(f)throw new Error("Failed to verify promoter pin availability");const g=(null===x||void 0===x?void 0:x.pins)||0;if(g<1)throw new Error('Selected promoter "'.concat(null===x||void 0===x?void 0:x.name,'" has insufficient pins (').concat(g," available). Please allocate pins to the promoter first."));const{data:y,error:v}=await d.ND.rpc("create_customer_final",r);if(v||null===y||void 0===y||!y.success){const e=(null===y||void 0===y?void 0:y.error)||(null===v||void 0===v?void 0:v.message)||"Failed to create customer";throw e.includes("Insufficient pins")?new Error("The selected promoter does not have enough PINs to create a new customer. Please allocate more PINs to the promoter first."):e.includes("Promoter not found")?new Error("The selected promoter was not found. Please select a valid promoter."):new Error(e)}const w=await m.deductPinForCustomerCreation(e.parentPromoter,y.customer_id,e.name);if(!w.success)throw new Error("Customer created but PIN deduction failed: ".concat(w.error));if(!y||!y.customer_id)throw new Error("Customer created but missing customer ID for commission distribution");const b=y.customer_id;if("string"!==typeof b||""===b.trim())throw new Error("Invalid customer ID format");await u.A.distributeCommission(b,e.parentPromoter);t("Customer created successfully and is ready to use.\n\nCard No: ".concat(e.cardNo,"\nName: ").concat(e.name,"\nLogin: Use Card No + Password")),await W(),Y()}}catch(x){r("Failed to ".concat(L?"update":"create"," customer: ").concat(x.message))}},promoters:A||[],isEditing:!!L,initialData:L,currentUserRole:"admin"}),M&&(0,_.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,_.jsxs)("div",{className:"bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4",children:[(0,_.jsx)("h3",{className:"text-lg font-semibold text-white mb-4",children:"Confirm Delete"}),(0,_.jsxs)("p",{className:"text-gray-300 mb-6",children:['Are you sure you want to delete customer "',null===R||void 0===R?void 0:R.name,'"? This action cannot be undone.']}),(0,_.jsxs)("div",{className:"flex justify-end space-x-3",children:[(0,_.jsx)("button",{onClick:Z,className:"px-4 py-2 text-gray-300 hover:text-white transition-colors",children:"Cancel"}),(0,_.jsx)("button",{onClick:async()=>{if(R)try{const{error:e}=await d.ND.from("profiles").delete().eq("id",R.id);if(e)throw e;t("Customer deleted successfully.\n\n".concat(R.name," has been removed from the system.")),await W(),Z()}catch(e){r("Failed to delete customer. Please try again.")}},className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Delete"})]})]})}),(0,_.jsx)(c.A,{isOpen:H,onClose:()=>{V(!1),$(null)},customerId:null===J||void 0===J?void 0:J.id,customerName:null===J||void 0===J?void 0:J.name,currentUser:e})]})]})}},3489:(e,t,r)=>{r.d(t,{A:()=>n,r:()=>a});var s=r(2555),i=r(6127),o=r(3848);const a={TOTAL_COMMISSION:800,LEVELS:{1:{amount:500,description:"Parent Promoter (Immediate Upline)"},2:{amount:100,description:"Next-Level Upline Promoter"},3:{amount:100,description:"Next-Level Upline Promoter"},4:{amount:100,description:"Next-Level Upline Promoter"}},STATUSES:{PENDING:"pending",CREDITED:"credited",FAILED:"failed"},RECIPIENT_TYPES:{PROMOTER:"promoter",ADMIN:"admin"}};const n=new class{async distributeCommission(e,t){try{o.Ay.info("\ud83c\udfaf Starting commission distribution",{customerId:e,initiatorPromoterId:t,totalAmount:a.TOTAL_COMMISSION});const c=await this.checkExistingCommission(e);if(c)return o.Ay.info("\u2139\ufe0f Commission already exists for customer - skipping distribution",{customerId:e,existingRecords:c.recordCount,totalDistributed:c.totalDistributed}),{success:!0,skipped:!0,message:"Commission already distributed for this customer (\u20b9".concat(c.totalDistributed," across ").concat(c.recordCount," records)"),existingCommission:c.allRecords,totalDistributed:c.totalDistributed,recordCount:c.recordCount};let l,d;try{o.Ay.info("\ud83c\udfaf Attempting database function: distribute_affiliate_commission");const r=await i.ND.rpc("distribute_affiliate_commission",{p_customer_id:e,p_initiator_promoter_id:t});if(l=r.data,d=r.error,l&&l.success)return o.Ay.info("\u2705 Database function succeeded, skipping fallback calculation"),{success:!0,data:l,message:"\u20b9".concat(l.total_distributed||a.TOTAL_COMMISSION," commission distributed via database function")};if(l&&l.skipped)return{success:!0,skipped:!0,data:l,message:l.message||"Commission already distributed"}}catch(n){var r,s;if(!(null!==(r=n.message)&&void 0!==r&&r.includes("Could not find the function")||null!==(s=n.message)&&void 0!==s&&s.includes("404")))throw n;o.Ay.warn("\u26a0\ufe0f Commission function not found, using fallback calculation",{customerId:e}),l=await this.calculateCommissionFallback(e,t),d=null}return d&&(o.Ay.error("\u274c Commission distribution failed",{error:d,customerId:e}),o.Ay.info("\ud83d\udd04 Attempting fallback commission calculation",{customerId:e}),l=await this.calculateCommissionFallback(e,t)),o.Ay.success("\u2705 Commission distribution completed",l),await this.triggerCommissionNotifications(l),{success:!0,data:l,message:"\u20b9".concat(a.TOTAL_COMMISSION," commission distributed successfully")}}catch(c){return o.Ay.error("\u274c Commission distribution service error",{error:c.message,customerId:e,initiatorPromoterId:t}),{success:!1,error:c.message}}}async calculateCommissionFallback(e,t){try{o.Ay.info("\ud83d\udcb0 Calculating commission using fallback method",{customerId:e,initiatorPromoterId:t});const s=[500,100,100,100];let a=t,n=0,c=0,l=800;for(let m=1;m<=4;m++){const d=s[m-1];if(a){try{const{error:r}=await i.ND.from("affiliate_commissions").insert({customer_id:e,initiator_promoter_id:t,recipient_id:a,recipient_type:"promoter",level:m,amount:d,status:"credited",transaction_id:"COM-".concat(String(Date.now()).slice(-6)),note:"Level ".concat(m," Commission - \u20b9").concat(d)});r?o.Ay.error("\u274c Failed to create commission record for level ".concat(m),r):(n+=d,l-=d,c++,o.Ay.info("\ud83d\udcb0 Level ".concat(m," commission: \u20b9").concat(d," to promoter ").concat(a," (\u20b9").concat(l," remaining in pool)")))}catch(r){o.Ay.error("\u274c Error creating commission record for level ".concat(m),r)}if(m<4)try{const{data:e,error:t}=await i.ND.from("profiles").select("parent_promoter_id, name, promoter_id").eq("id",a).single();!t&&null!==e&&void 0!==e&&e.parent_promoter_id?(a=e.parent_promoter_id,o.Ay.info("\ud83d\udd17 Moving to parent promoter: ".concat(a," for level ").concat(m+1))):(o.Ay.info("\ud83d\udeab No parent promoter found for level ".concat(m+1)),a=null)}catch(r){o.Ay.error("\u274c Error fetching parent promoter for level ".concat(m+1),r),a=null}}else o.Ay.info("\ud83d\udeab LEVEL ".concat(m," NO PROMOTER:"),{level:m,amount:d,message:"\u20b9".concat(d," stays in pool for admin"),remainingPool:l})}if(l>0)try{const{error:r}=await i.ND.from("affiliate_commissions").insert({customer_id:e,initiator_promoter_id:t,recipient_id:null,recipient_type:"admin",level:0,amount:l,status:"credited",transaction_id:"COM-".concat(String(Date.now()).slice(-6)),note:"Admin Fallback - Remaining from \u20b9800 pool - \u20b9".concat(l)});r?o.Ay.error("\u274c Failed to create admin commission record",r):(n+=l,o.Ay.info("\ud83d\udcb0 Admin commission: \u20b9".concat(l," from remaining pool")))}catch(r){o.Ay.error("\u274c Error creating admin commission record",r)}const d={success:!0,customer_id:e,initiator_promoter_id:t,total_distributed:n,levels_distributed:c,admin_fallback:l,timestamp:(new Date).toISOString(),method:"fallback_calculation",message:"Commission calculated via fallback: \u20b9".concat(n," distributed across ").concat(c," levels")};return this.storeCommissionRecord(d),d}catch(r){return o.Ay.error("\u274c Fallback commission calculation failed",{error:r,customerId:e}),{success:!0,customer_id:e,initiator_promoter_id:t,total_distributed:a.TOTAL_COMMISSION,levels_distributed:4,admin_fallback:0,timestamp:(new Date).toISOString(),method:"basic_fallback",message:"Commission recorded for manual processing"}}}storeCommissionRecord(e){try{const t=JSON.parse(localStorage.getItem("commission_audit_trail")||"[]");t.push((0,s.A)((0,s.A)({},e),{},{stored_at:(new Date).toISOString()})),t.length>100&&t.splice(0,t.length-100),localStorage.setItem("commission_audit_trail",JSON.stringify(t)),o.Ay.info("\ud83d\udcdd Commission record stored for audit",{customer_id:e.customer_id})}catch(t){o.Ay.error("\u274c Failed to store commission record",{error:t})}}async checkExistingCommission(e){try{const{data:t,error:r}=await i.ND.from("affiliate_commissions").select("id, customer_id, amount, recipient_type, status, created_at").eq("customer_id",e).eq("status","credited");if(r)throw r;if(t&&t.length>0){const r=t.reduce((e,t)=>e+parseFloat(t.amount),0);return o.Ay.warn("\ud83d\udeab Commission already exists for customer",{customerId:e,existingRecords:t.length,totalDistributed:r,records:t}),{exists:!0,recordCount:t.length,totalDistributed:r,firstRecord:t[0],allRecords:t}}return null}catch(t){return o.Ay.error("Error checking existing commission",{error:t,customerId:e}),null}}async getPromoterCommissionSummary(e){try{const{data:t,error:r}=await i.ND.rpc("get_promoter_commission_summary",{p_promoter_id:e});if(r)throw r;return{success:!0,data:t||{promoter_id:e,wallet_balance:0,total_earned:0,commission_count:0,recent_commissions:[]}}}catch(t){return o.Ay.error("Error getting promoter commission summary",{error:t,promoterId:e}),await this.getBasicWalletInfo(e)}}async getBasicWalletInfo(e){try{const{data:t,error:r}=await i.ND.from("profiles").select("wallet_balance").eq("id",e).eq("role","promoter").single(),{data:s,error:o}=await i.ND.from("affiliate_commissions").select("\n          id,\n          customer_id,\n          initiator_promoter_id,\n          level,\n          amount,\n          status,\n          created_at,\n          note\n        ").eq("recipient_id",e).eq("status","credited").order("created_at",{ascending:!1}).limit(10),{data:a}=await i.ND.from("affiliate_commissions").select("amount").eq("recipient_id",e).eq("status","credited"),n=(null===a||void 0===a?void 0:a.reduce((e,t)=>e+(parseFloat(t.amount)||0),0))||0,c=(null===a||void 0===a?void 0:a.length)||0;return{success:!0,data:{promoter_id:e,wallet_balance:parseFloat(null===t||void 0===t?void 0:t.wallet_balance)||n,total_earned:n,commission_count:c,recent_commissions:s||[]}}}catch(t){return o.Ay.error("Error getting basic wallet info",{error:t,promoterId:e}),{success:!1,error:t.message,data:{promoter_id:e,wallet_balance:0,total_earned:0,commission_count:0,recent_commissions:[]}}}}async getAdminCommissionSummary(){try{const{data:e,error:t}=await i.ND.rpc("get_admin_commission_summary");if(t)throw t;return{success:!0,data:e||{wallet_balance:0,total_received:0,unclaimed_total:0,commission_count:0,daily_summary:[]}}}catch(e){return o.Ay.error("Error getting admin commission summary",{error:e}),await this.getBasicAdminInfo()}}async getBasicAdminInfo(){try{const{data:e,error:t}=await i.ND.from("profiles").select("id").eq("role","admin").limit(1).single();if(t||!e)throw new Error("Admin not found");const r=JSON.parse(localStorage.getItem("admin_unclaimed_commissions")||"[]"),s=r.reduce((e,t)=>e+(t.amount||0),0),o=r.length,{data:a,error:n}=await i.ND.from("admin_wallet").select("*").eq("admin_id",e.id).single(),{data:c,error:l}=await i.ND.from("affiliate_commissions").select("*").eq("recipient_type","admin").order("created_at",{ascending:!1}).limit(20);return{success:!0,data:{admin_id:e.id,wallet_balance:((null===a||void 0===a?void 0:a.balance)||0)+s,total_received:(null===a||void 0===a?void 0:a.total_commission_received)||0,unclaimed_total:s,commission_count:((null===a||void 0===a?void 0:a.commission_count)||0)+o,recent_commissions:[...c||[],...r.slice(-10)]}}}catch(e){return o.Ay.error("Error getting basic admin info",{error:e}),{success:!1,error:e.message,data:{wallet_balance:0,total_received:0,unclaimed_total:0,commission_count:0,recent_commissions:[]}}}}async getCommissionHistory(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{let t=i.ND.from("affiliate_commissions").select("\n          *,\n          initiator:profiles!affiliate_commissions_initiator_promoter_id_fkey(name, email),\n          recipient:profiles!affiliate_commissions_recipient_id_fkey(name, email, role)\n        ");e.promoterId&&(t=t.or("recipient_id.eq.".concat(e.promoterId,",initiator_promoter_id.eq.").concat(e.promoterId))),e.level&&(t=t.eq("level",e.level)),e.status&&(t=t.eq("status",e.status)),e.dateFrom&&(t=t.gte("created_at",e.dateFrom)),e.dateTo&&(t=t.lte("created_at",e.dateTo)),t=t.order("created_at",{ascending:!1});const{data:r,error:s}=await t;if(s)throw s;return{success:!0,data:r||[],count:(null===r||void 0===r?void 0:r.length)||0}}catch(t){return o.Ay.error("Error getting commission history",{error:t,filters:e}),{success:!1,error:t.message,data:[]}}}async triggerCommissionNotifications(e){try{o.Ay.info("\ud83d\udce2 Triggering commission notifications",e)}catch(t){o.Ay.error("Error triggering notifications",{error:t})}}async manualDistributeCommission(e,t,r){try{o.Ay.info("\ud83d\udd27 Manual commission distribution initiated",{customerId:e,initiatorPromoterId:t,adminId:r});const{data:s,error:a}=await i.ND.from("profiles").select("role").eq("id",r).eq("role","admin").single();if(a||!s)throw new Error("Unauthorized: Admin access required");return await this.distributeCommission(e,t)}catch(s){return o.Ay.error("\u274c Manual commission distribution failed",{error:s}),{success:!1,error:s.message}}}async getCommissionStatistics(){try{const{data:e,error:t}=await i.ND.from("affiliate_commissions").select("level, amount, status, created_at, recipient_type");if(t)throw t;const r={totalCommissions:e.length,totalAmount:e.reduce((e,t)=>e+parseFloat(t.amount),0),byLevel:{},byStatus:{},byRecipientType:{},monthlyTrend:{}};return e.forEach(e=>{r.byLevel[e.level]=(r.byLevel[e.level]||0)+1,r.byStatus[e.status]=(r.byStatus[e.status]||0)+1,r.byRecipientType[e.recipient_type]=(r.byRecipientType[e.recipient_type]||0)+1;const t=new Date(e.created_at).toISOString().substring(0,7);r.monthlyTrend[t]||(r.monthlyTrend[t]={count:0,amount:0}),r.monthlyTrend[t].count+=1,r.monthlyTrend[t].amount+=parseFloat(e.amount)}),{success:!0,data:r}}catch(e){return o.Ay.error("Error getting commission statistics",{error:e}),{success:!1,error:e.message,data:{}}}}}},5680:(e,t,r)=>{r.d(t,{A:()=>s});const s=(0,r(3797).A)("Phone",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]])},5722:(e,t,r)=>{r.d(t,{A:()=>s});const s=(0,r(3797).A)("CreditCard",[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]])},6339:(e,t,r)=>{r.d(t,{A:()=>s});const s=(0,r(3797).A)("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]])},6787:(e,t,r)=>{r.d(t,{A:()=>s});const s=(0,r(3797).A)("PenSquare",[["path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1qinfi"}],["path",{d:"M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z",key:"w2jsv5"}]])},8112:(e,t,r)=>{r.d(t,{A:()=>s});const s=(0,r(3797).A)("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]])},9256:(e,t,r)=>{r.d(t,{A:()=>s});const s=(0,r(3797).A)("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]])}}]);
//# sourceMappingURL=779.2b11cdfc.chunk.js.map