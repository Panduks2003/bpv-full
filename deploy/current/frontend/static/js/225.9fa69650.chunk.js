"use strict";(self.webpackChunkbrightplanet_ventures=self.webpackChunkbrightplanet_ventures||[]).push([[225],{98:(e,t,r)=>{r.d(t,{A:()=>n});const n=(0,r(3797).A)("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]])},254:(e,t,r)=>{r.d(t,{Ay:()=>u});var n=r(2555),o=r(6127),a=r(5229);const s={PENDING:"pending",APPROVED:"approved",REJECTED:"rejected"},i={[s.PENDING]:{emoji:"\ud83d\udfe1",label:"Pending",color:"yellow",description:"Waiting for admin approval"},[s.APPROVED]:{emoji:"\ud83d\udfe2",label:"Approved",color:"green",description:"PINs allocated successfully"},[s.REJECTED]:{emoji:"\ud83d\udd34",label:"Rejected",color:"red",description:"Request declined by admin"}},c=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50;try{const{data:s,error:c}=await o.ND.from("pin_requests").select("id").limit(1);if(c&&("42P01"===c.code||"42703"===c.code||"PGRST106"===c.code||"PGRST301"===c.code))return console.warn("PIN requests table not found or RLS policies blocking access. Please run the database setup script."),[];const{data:l,error:d}=await o.ND.rpc("get_pin_requests",{p_promoter_id:e,p_status:t,p_limit:r});if(d){var a;if("42883"===d.code||"PGRST202"===d.code){console.warn("get_pin_requests function not found. Using direct table query."),console.warn("Using simple query without joins to avoid relationship issues.");let a=o.ND.from("pin_requests").select("*").order("created_at",{ascending:!1}).limit(r);e&&(a=a.eq("promoter_id",e)),t&&(a=a.eq("status",t));const{data:s,error:c}=await a;if(c){if("42P01"===c.code||"PGRST200"===c.code||"PGRST301"===c.code)return console.warn("pin_requests table not found, relationships missing, or RLS blocking access. Returning empty array."),[];throw c}return s.map(e=>(0,n.A)((0,n.A)({},e),{},{requested_pins:e.quantity,request_number:e.request_id,approved_by:e.processed_by,approved_at:e.response_date,promoter_name:"Promoter",promoter_email:"promoter@example.com",admin_name:null,statusConfig:i[e.status]||{emoji:"\u2753",label:"Unknown",color:"gray",description:"Unknown status"},formattedRequestNumber:e.formatted_request_id||"REQ-".concat(String(e.request_id||e.request_number).padStart(3,"0")),formattedDate:new Date(e.created_at).toLocaleDateString(),formattedTime:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}))}if(null!==(a=d.message)&&void 0!==a&&a.includes("does not exist")||"42703"===d.code)return console.warn("PIN requests table/function not found. Returning empty array."),[];throw d}return l.map(e=>(0,n.A)((0,n.A)({},e),{},{statusConfig:i[e.status]||{emoji:"\u2753",label:"Unknown",color:"gray",description:"Unknown status"},formattedRequestNumber:e.formatted_request_id||"REQ-".concat(String(e.request_number).padStart(3,"0")),formattedDate:new Date(e.created_at).toLocaleDateString(),formattedTime:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}))}catch(s){throw console.error("\u274c Failed to get PIN requests:",s),s}},l=async(e,t,r)=>{const{data:n,error:s}=await o.ND.from("pin_requests").select("*").eq("id",e).eq("status","pending").single();if(s||!n)throw new Error("Request not found or already processed");console.log("\ud83d\udccb Request data for approval:",n);const i=await a.Ay.adminAllocatePins(n.promoter_id,n.quantity||n.requested_pins,t);if(!i.success)throw new Error("Failed to allocate PINs: ".concat(i.error));const{error:c}=await o.ND.from("pin_requests").update({status:"approved",processed_by:t,admin_notes:r,response_date:(new Date).toISOString()}).eq("id",e);if(c)throw new Error("Failed to update request status: ".concat(c.message));return{success:!0,request_id:e,promoter_id:n.promoter_id,allocated_pins:n.requested_pins,new_balance:i.balance_after,message:"PIN request approved and PINs allocated successfully"}},d=async(e,t,r)=>{const{data:n,error:a}=await o.ND.from("pin_requests").select("*").eq("id",e).eq("status","pending").single();if(a||!n)throw new Error("Request not found or already processed");const{error:s}=await o.ND.from("pin_requests").update({status:"rejected",processed_by:t,admin_notes:r||"Request rejected by admin",response_date:(new Date).toISOString()}).eq("id",e);if(s)throw new Error("Failed to update request status: ".concat(s.message));return{success:!0,request_id:e,promoter_id:n.promoter_id,message:"PIN request rejected"}},u={submitPinRequest:async function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;try{console.log("\ud83d\udd04 Submitting PIN request:",{promoterId:e,requestedPins:t,reason:r});const{data:a,error:s}=await o.ND.rpc("submit_pin_request",{p_promoter_id:e,p_requested_pins:t,p_reason:r});if(s){var n;if("42883"===s.code||"PGRST202"===s.code){if(console.warn("submit_pin_request function not found. Using direct table insert."),!t||t<=0||t>1e3)throw new Error("Requested PINs must be between 1 and 1000");const{data:n}=await o.ND.from("pin_requests").select("id").eq("promoter_id",e).eq("status","pending");if(n&&n.length>0)throw new Error("You already have a pending PIN request. Please wait for admin approval.");const{data:a,error:s}=await o.ND.from("pin_requests").insert({promoter_id:e,quantity:t,reason:r||"PIN request submitted",category:"standard",urgency:"normal"}).select("*").single();if(s)throw s;return{success:!0,request_id:a.id,request_number:a.request_id,message:"PIN request submitted successfully"}}if(null!==(n=s.message)&&void 0!==n&&n.includes("does not exist"))throw new Error("PIN request system is not set up. Please contact administrator to run the database setup.");throw console.error("\u274c PIN request submission failed:",s),s}if(!a.success)throw console.error("\u274c PIN request returned error:",a.error),new Error(a.error||"PIN request submission failed");return console.log("\u2705 PIN request submitted successfully:",a),a}catch(a){throw console.error("\u274c PIN request service error:",a),a}},getPinRequests:c,approvePinRequest:async function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;try{console.log("\ud83d\udd04 Approving PIN request:",{requestId:e,adminId:t,adminNotes:r});const{data:n,error:a}=await o.ND.rpc("approve_pin_request",{p_request_id:e,p_admin_id:t,p_admin_notes:r});if(a){if("42883"===a.code||"PGRST202"===a.code)return console.warn("approve_pin_request function not found. Using manual approval process."),await l(e,t,r);throw console.error("\u274c PIN request approval failed:",a),a}if(!n.success)throw console.error("\u274c PIN request approval returned error:",n.error),new Error(n.error||"PIN request approval failed");return console.log("\u2705 PIN request approved successfully:",n),n}catch(n){throw console.error("\u274c PIN request approval service error:",n),n}},rejectPinRequest:async function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;try{console.log("\ud83d\udd04 Rejecting PIN request:",{requestId:e,adminId:t,adminNotes:r});const{data:n,error:a}=await o.ND.rpc("reject_pin_request",{p_request_id:e,p_admin_id:t,p_admin_notes:r});if(a){if("42883"===a.code||"PGRST202"===a.code)return console.warn("reject_pin_request function not found. Using manual rejection process."),await d(e,t,r);throw console.error("\u274c PIN request rejection failed:",a),a}if(!n.success)throw console.error("\u274c PIN request rejection returned error:",n.error),new Error(n.error||"PIN request rejection failed");return console.log("\u2705 PIN request rejected successfully:",n),n}catch(n){throw console.error("\u274c PIN request rejection service error:",n),n}},getPinRequestStats:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;try{const t=await c(e);return{totalRequests:t.length,pendingRequests:t.filter(e=>e.status===s.PENDING).length,approvedRequests:t.filter(e=>e.status===s.APPROVED).length,rejectedRequests:t.filter(e=>e.status===s.REJECTED).length,totalPinsRequested:t.reduce((e,t)=>e+t.requested_pins,0),totalPinsApproved:t.filter(e=>e.status===s.APPROVED).reduce((e,t)=>e+t.requested_pins,0)}}catch(t){return console.error("\u274c Failed to get PIN request stats:",t),{totalRequests:0,pendingRequests:0,approvedRequests:0,rejectedRequests:0,totalPinsRequested:0,totalPinsApproved:0}}},hasPendingRequests:async e=>{try{return(await c(e,s.PENDING,1)).length>0}catch(t){return console.error("\u274c Failed to check pending requests:",t),!1}},subscribeToPinRequests:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r="";t&&(r="promoter_id=eq.".concat(t));return o.ND.channel("pin-requests-changes").on("postgres_changes",{event:"*",schema:"public",table:"pin_requests",filter:r},t=>{console.log("\ud83d\udce1 PIN requests change detected:",t),e(t)}).subscribe()},formatPinRequest:e=>(0,n.A)((0,n.A)({},e),{},{displayTitle:"".concat(e.formattedRequestNumber," - ").concat(e.requested_pins," PIN").concat(e.requested_pins>1?"s":""),displayStatus:"".concat(e.statusConfig.emoji," ").concat(e.statusConfig.label),displayDate:"".concat(e.formattedDate," at ").concat(e.formattedTime),displayReason:e.reason||"No reason provided"}),validatePinRequest:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const r=[];return(!e||e<=0)&&r.push("Requested PINs must be greater than 0"),e>1e3&&r.push("Cannot request more than 1000 PINs at once"),t&&t.length>500&&r.push("Reason must be less than 500 characters"),{isValid:0===r.length,errors:r}},PIN_REQUEST_STATUS:s,PIN_REQUEST_CONFIG:i}},430:(e,t,r)=>{r.d(t,{A:()=>n});const n=(0,r(3797).A)("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]])},1065:(e,t,r)=>{r.d(t,{A:()=>n});const n=(0,r(3797).A)("XCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]])},5229:(e,t,r)=>{r.d(t,{Ay:()=>d,D7:()=>c,Lh:()=>l,getUserPinBalance:()=>i,hO:()=>a});var n=r(2555),o=r(6127);const a={CUSTOMER_CREATION:"customer_creation",ADMIN_ALLOCATION:"admin_allocation",ADMIN_DEDUCTION:"admin_deduction"},s={[a.CUSTOMER_CREATION]:{emoji:"\u274c",label:"Customer Creation",color:"red",sign:"-"},[a.ADMIN_ALLOCATION]:{emoji:"\u2705",label:"Admin Allocation",color:"green",sign:"+"},[a.ADMIN_DEDUCTION]:{emoji:"\u274c",label:"Admin Deduction",color:"red",sign:"-"}},i=async e=>{try{const{data:t,error:r}=await o.ND.from("profiles").select("pins").eq("id",e).single();if(r)throw r;return t.pins||0}catch(t){throw console.error("\u274c Failed to get user PIN balance:",t),t}},c=(e,t)=>{if(null===t||void 0===t)return"0";if(!s[e])return t.toString();const r=Math.abs(t);return e===a.ADMIN_ALLOCATION?"+".concat(r):"-".concat(r)},l=e=>s[e]||{emoji:"\u2753",label:"Unknown",color:"gray",sign:""},d={executePinTransaction:async e=>{let{userId:t,actionType:r,pinChangeValue:n,createdBy:a=null,relatedEntityId:s=null,relatedEntityName:i=null}=e;try{console.log("\ud83d\udd04 Executing PIN transaction:",{userId:t,actionType:r,pinChangeValue:n,createdBy:a,relatedEntityId:s,relatedEntityName:i});const{data:e,error:c}=await o.ND.rpc("execute_pin_transaction",{p_user_id:t,p_action_type:r,p_pin_change_value:n,p_created_by:a,p_related_entity_id:s,p_related_entity_name:i});if(c)throw console.error("\u274c PIN transaction failed:",c),c;if(!e.success)throw console.error("\u274c PIN transaction returned error:",e.error),new Error(e.error||"PIN transaction failed");return console.log("\u2705 PIN transaction successful:",e),e}catch(c){throw console.error("\u274c PIN transaction service error:",c),c}},deductPinForCustomerCreation:async(e,t,r)=>{try{console.log("\ud83d\udd04 Deducting PIN for customer creation:",{promoterId:e,customerId:t,customerName:r});const{data:n,error:a}=await o.ND.rpc("deduct_pin_for_customer_creation",{p_promoter_id:e,p_customer_id:t,p_customer_name:r});if(a)throw a;if(!n.success)throw new Error(n.error||"Customer creation PIN deduction failed");return console.log("\u2705 Customer creation PIN deduction successful:",n),n}catch(n){throw console.error("\u274c Customer creation PIN deduction failed:",n),n}},adminAllocatePins:async(e,t,r)=>{try{console.log("\ud83d\udd04 Admin allocating PINs:",{targetUserId:e,pinAmount:t,adminId:r});const{data:n,error:a}=await o.ND.rpc("admin_allocate_pins",{p_target_user_id:e,p_pin_amount:Math.abs(t),p_admin_id:r});if(a)throw a;if(!n.success)throw new Error(n.error||"Admin PIN allocation failed");return console.log("\u2705 Admin PIN allocation successful:",n),n}catch(n){throw console.error("\u274c Admin PIN allocation failed:",n),n}},adminDeductPins:async(e,t,r)=>{try{console.log("\ud83d\udd04 Admin deducting PINs:",{targetUserId:e,pinAmount:t,adminId:r});const{data:n,error:a}=await o.ND.rpc("admin_deduct_pins",{p_target_user_id:e,p_pin_amount:Math.abs(t),p_admin_id:r});if(a)throw a;if(!n.success)throw new Error(n.error||"Admin PIN deduction failed");return console.log("\u2705 Admin PIN deduction successful:",n),n}catch(n){throw console.error("\u274c Admin PIN deduction failed:",n),n}},getUserPinTransactions:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50;try{const{data:r,error:a}=await o.ND.from("pin_transactions").select("\n        id,\n        transaction_id,\n        action_type,\n        pin_change_value,\n        balance_before,\n        balance_after,\n        note,\n        created_at,\n        created_by,\n        related_entity_id,\n        creator:profiles!created_by(name, email)\n      ").eq("user_id",e).order("created_at",{ascending:!1}).limit(t);if(a)throw a;return r.map(e=>{var t;return(0,n.A)((0,n.A)({},e),{},{displayConfig:s[e.action_type]||{emoji:"\u2753",label:"Unknown",color:"gray",sign:""},formattedAmount:c(e.action_type,e.pin_change_value),creatorName:(null===(t=e.creator)||void 0===t?void 0:t.name)||"System"})})}catch(r){throw console.error("\u274c Failed to get user PIN transactions:",r),r}},getAllPinTransactions:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;try{let r=o.ND.from("pin_transactions").select("\n        id,\n        transaction_id,\n        user_id,\n        action_type,\n        pin_change_value,\n        balance_before,\n        balance_after,\n        note,\n        created_at,\n        created_by,\n        related_entity_id,\n        user:profiles!user_id(name, email, role),\n        creator:profiles!created_by(name, email)\n      ").order("created_at",{ascending:!1}).limit(t);e.actionType&&"all"!==e.actionType&&(r=r.eq("action_type",e.actionType)),e.userId&&(r=r.eq("user_id",e.userId)),e.dateFrom&&(r=r.gte("created_at",e.dateFrom)),e.dateTo&&(r=r.lte("created_at",e.dateTo));const{data:a,error:i}=await r;if(i)throw i;return a.map(e=>{var t,r,o,a;return(0,n.A)((0,n.A)({},e),{},{displayConfig:s[e.action_type]||{emoji:"\u2753",label:"Unknown",color:"gray",sign:""},formattedAmount:c(e.action_type,e.pin_change_value||0),userName:(null===(t=e.user)||void 0===t?void 0:t.name)||"Unknown User",userEmail:(null===(r=e.user)||void 0===r?void 0:r.email)||"Unknown",userRole:(null===(o=e.user)||void 0===o?void 0:o.role)||"unknown",creatorName:(null===(a=e.creator)||void 0===a?void 0:a.name)||"System"})})}catch(r){throw console.error("\u274c Failed to get all PIN transactions:",r),r}},getUserPinBalance:i,getPinTransactionStats:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;try{let t=o.ND.from("pin_transactions").select("action_type, pin_change_value");e&&(t=t.eq("user_id",e));const{data:r,error:n}=await t;if(n)throw n;return{totalTransactions:r.length,customerCreations:r.filter(e=>e.action_type===a.CUSTOMER_CREATION).length,adminAllocations:r.filter(e=>e.action_type===a.ADMIN_ALLOCATION).length,adminDeductions:r.filter(e=>e.action_type===a.ADMIN_DEDUCTION).length,totalPinsAllocated:r.filter(e=>e.action_type===a.ADMIN_ALLOCATION).reduce((e,t)=>e+Math.abs(t.pin_change_value),0),totalPinsDeducted:r.filter(e=>e.action_type!==a.ADMIN_ALLOCATION).reduce((e,t)=>e+Math.abs(t.pin_change_value),0)}}catch(t){throw console.error("\u274c Failed to get PIN transaction stats:",t),t}},formatPinAmount:c,getActionTypeDisplay:l,validatePinTransaction:(e,t,r)=>{const n=[];return Object.values(a).includes(e)||n.push("Invalid action type"),(!t||t<=0)&&n.push("PIN amount must be greater than 0"),r||n.push("User ID is required"),{isValid:0===n.length,errors:n}},subscribeToPinBalance:(e,t)=>o.ND.channel("pin-balance-changes").on("postgres_changes",{event:"*",schema:"public",table:"pin_transactions",filter:"user_id=eq.".concat(e)},e=>{console.log("\ud83d\udce1 PIN transaction change detected:",e),t(e)}).subscribe(),subscribeToPinTransactions:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r="";t&&(r="user_id=eq.".concat(t));return o.ND.channel("pin-transactions-changes").on("postgres_changes",{event:"*",schema:"public",table:"pin_transactions",filter:r},t=>{console.log("\ud83d\udce1 PIN transactions change detected:",t),e(t)}).subscribe()},PIN_ACTION_TYPES:a,PIN_DISPLAY_CONFIG:s}},9213:(e,t,r)=>{r.d(t,{A:()=>n});const n=(0,r(3797).A)("Pin",[["line",{x1:"12",x2:"12",y1:"17",y2:"22",key:"1jrz49"}],["path",{d:"M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z",key:"13yl11"}]])},9256:(e,t,r)=>{r.d(t,{A:()=>n});const n=(0,r(3797).A)("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]])}}]);
//# sourceMappingURL=225.9fa69650.chunk.js.map